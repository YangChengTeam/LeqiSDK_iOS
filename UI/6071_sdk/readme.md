# SDK 维护文档

- [概述](#概述)
- [功能说明](#功能说明)
- [API](#API)

## 概述
### 目录结构
本项目分六个模块，分别是 `Application` 目录下的 `Admin/Api/Agent/Box/H5/Home` 等目录：
- `Admin`：后台管理模块。
- `Api`：SDK接口模块。
- `Agent`：渠道后台模块。
- `Box`：游戏盒子接口模块。
- `H5`：H5游戏接口及js-sdk模块。
- `Home`：静态页面模块。


### 依赖外部服务
- 游戏打包服务：`http://apk.6071.com/exepackage.php`、`http://tapi.6071.com/exepackage.php`
- 游戏盒子打包服务：`http://apk.6071.com/boxpackage/boxpackage_new.php`


### 依赖第三方服务
- 支付：支付宝、现在支付(微信)、IAP苹果支付
- 短信：光通、乐信（已停止）
- 提现：现在支付代付(微信)
- 实名认证：现在支付实名认证
- 广告数据：今日头条广告数据、汇川广告数据


### 业务流程简述
1. 游戏管理。在与游戏厂商对接参数后，进入后台并录入数据。
1. 游戏接口调试。游戏厂商按照我方文档接入 `SDK` 并对接好**登录、充值、回调**接口后，提供游戏母包给我方。
1. 游戏分包。我方从游戏厂商处拿回母包后，部署至打包服务器。由渠道在渠道后台申请推广游戏并打好子包。
1. 运营与数据统计分析。


## 功能说明
本系统基于 `ThinkPHP3.2`，`Admin` 后台模块有借鉴 `onethink` 中的很多实现，包括后台的UI、登录授权、菜单。

### 渠道及子渠道系统
渠道分一级渠道与二级渠道，一级渠道在 `http://tui.6071.com` 注册后，经后台审核后可用；二级渠道由一级渠道手动分配，当一级渠道分配的二级渠道数量过多时，会触发后台审核，具体限制可在后台设置。

*相关表：*
- `s_agent`: 渠道信息表

### 游戏分包
一级渠道申请的游戏不进行实际分包，只是申请游戏的推广权限，只有一级渠道申请过的游戏，二级渠道才能进行申请、分包、推广。

*相关表：*
- `s_game`: 游戏信息表
- `s_agent_game`: 渠道取包记录

### SDK
后台可以给渠道授权SDK定制权限。拥有授权的渠道可以设置SDK的logo、浮标、颜色、退出广告。

*相关表：*
- `s_sdk_diyfloatico`: SDK自定义浮标信息表
- `s_sdk_floatico`: SDK系统浮标信息表
- `s_sdk_module`: SDK个人中心模块表
- `s_sdk_template`: SDK皮肤信息表


### 游戏盒子
一级渠道申请盒子成功后，会生成一个盒子的母包（需要脚本执行解包打包等操作，耗时较长）。二级渠道可以根据盒子母包，打盒子子包（插入json信息，很快）。盒子相关内容及设置，在一级渠道后台。二级渠道后台负责取包及推广。当盒子升级时，先更新盒子原始包，后台添加更新日志。然后后台重新打包一级渠道的盒子母包。一级渠道母包升级之后，二级渠道的盒子子包才会收到更新提示。
游戏盒子高级功能：预安装包、捆绑包、释放快捷方式、自定义导入游戏。


*相关表：*
- `s_agent_box`: 渠道游戏盒子信息及设置数据表。
- `s_box_package`: 渠道盒子打包记录表
- `s_box_update_log`: 盒子升级日志
- `s_box_package_link`: 盒子打包捆绑数据
- `s_box_package_pre`: 盒子打包预安装数据
- `s_game_api`: 导入游戏信息表
- `s_game_api_setting`: 导入游戏设置表
- `s_import_task`: 导入游戏任务表
- `s_import_page_log`: 导入游戏列表记录
- `s_import_game_log`: 导入游戏记录

### 积分系统与积分商城
管理员在后台添加积分活动规则，一级渠道设置启用哪些规则，二级渠道设置相关规则的具体积分额度。用户行为满足规则会获取积分，积分用户在积分商城中兑换商品。

管理员在后台管理积分商城，添加商品分类与商品。渠道自动拥有商城功能，但是需要给渠道授权商品分类，只有渠道取得授权的分类下的商品，才给予展示。用户可以通过游戏盒子，在积分商品中兑换商品，同时消耗渠道的信用额度。渠道可以主动偿还信用额度，或者在结算时自动优先偿还信用额度。

*相关表：*
- `s_point_action`: 后台积分规则
- `s_agent_point_action`: 渠道积分规则
- `s_goods`: 商品信息表
- `s_goods_type`: 商品分类表
- `s_goods_type_agent`: 渠道商品分类授权记录
- `s_agent_credit`: 渠道信用额度变更记录
- `s_user_goods`: 用户兑换记录
- `s_user_point_log`: 用户积分日志

### 用户系统
用户来源于SDK注册与游戏盒子注册。用户数据在SDK与游戏盒子中互通。同一个用户，可以同时登陆平台下的所有游戏。用户注册太频繁会触发限制注册。**注意：若用户登录渠道未申请的游戏，会导致统计数据与对账数据不一致，因为未申请的游戏不出现在对账表中。**

*相关表：*
- `s_user`: 用户信息表
- `s_user_game`: 用户游戏表

### 订单系统
用户游戏充值、平台币充值行为产生订单充值消费记录；来自渠道的转账，生成订单转账记录；通过积分兑换的游戏币也会记录到订单表。这样处理可以包含用户账户变化的所有记录，方便形成用户流水。
- 平台币充值流程
```
用户创建充值订单 - 付款成功 - 收到第三方充值回调 - 更新用户平台币余额 - 订单状态更新
```

- 游戏充值流程
```
用户创建游戏充值订单 - 混合支付预扣费 - [付款成功 - 收到第三方充值回调 - 更新用户平台币余额 - 订单状态更新 - 扣除订单余额] - 通知游戏 - 订单状态更新
```

由于游戏充值过程是混合支付，各环节会因条件不同而有所差别。若预扣费环节足以覆盖订单金额，则不会唤起第三方支付，直接进行通知游戏环节。总之会遵循以下原则：
- 平台币、游戏币、优惠券等平台账户余额的款项在创建订单后即扣除。
- 第三方支付金额始终会先进入平台币账户。
- 在通知游戏前一环节会验证所有款项是否扣除完毕。由于预扣费环节，其实只需要验证第三方支付部分是否从平台币扣除。

IOS下的支付环节有所不同，IOS下的IAP支付不存在第三发支付回调，由客户端确认付款成功后，请求服务端发起订单状态验证。
```
用户创建充值订单 - 付款成功 - 服务端查询IAP订单状态 - 通知游戏 - 订单状态更新
```

*相关表：*
- `s_orders`: 订单信息表
- `s_order_ios`: IAP支付订单验证凭证。

### 提现系统
这里的提现只针对微信支付的款项。微信支付是通过第三方现在支付来完成，用户微信支付的款项都会进入现在支付的账户。从现在支付的账户提现，需要通过现在支付提供的专门的接口。提现系统仅限后台使用。具体使用说明见现在支付提供的文档：代收付。

*相关表：*
- `s_account_card`: 提现账户
- `s_account_user`: 账户所有者
- `s_account_withdraw`: 提现记录

### 实名认证
实名认证是利用现在支付提供的实名认证接口。现在支付提供的实名认证接口包括：两元素、三元素、四元素接口。我们开通的是两元素的，即：姓名+身份证号认证。具体使用说明见现在支付提供的文档：鉴权技术包。

*相关表：*
- `s_user_real_auth`: 实名认证记录表


### 抽奖功能
抽奖功能主入口文件：`Application/Api/Server/LockDraw.class.php`。抽奖活动内容由后台管理。一般使用流程如下：
```
后台添加抽奖活动 - 活动奖品及参数设置 - 用户抽奖
```
可以添加多个抽奖活动，若活动规则有变化，需要先实现活动规则的类文件，调试通过后上线。活动规则类命名空间是：`Api\Server\LuckDraw`。每个类都需要继承 `AbstractLuckDraw` 类。活动所使用的活动规则类，由字段 `name` 决定。

*相关表：*
- `s_luck_draw`: 活动信息表
- `s_luck_draw_goods`: 活动奖品信息表
- `s_luck_draw_logs`: 活动抽奖记录表

### H5游戏-jssdk
jssdk基于前端框架vue来实现。jssdk源文件目录是 `Public/H5/assets`。实现思路是，在原始页面A中嵌入一个iframe，在iframe中加载游戏，iframe填充页面A。在页面A中添加其他所需元素E，浮在iframe只上。用户的操作分为两大块。第一是当元素E不存在时，用户操作发生在iframe层，属于游戏操作；第二是当元素E存在时，用户操作发生在元素E上，属于jssdk用户相关操作。所有行为都不应该刷新页面A，否则导致游戏重新加载，打断游戏体验。
一些注意事项：
- 除非用户手动刷新页面，否则禁止做reload操作，执行相关功能时，也要尽量避免页面跳转，或者新开一个iframe做页面跳转。如：付款中间页、支付宝手机网页支付。
- 有些操作无法在frame层完成，则需要将操作事件及参数传递到页面A中再进行处理。如：微信APP内唤起微信支付、IOS下safari通过协议唤起微信支付。

### 广告数据
在通过第三方进行游戏推广时，第三方在收到用户广告点击行为后，会发送点击数据到我方服务器。我方收到数据请求后，保存必要参数，完成数据的同步。然后会根据广告目标监测用户的激活、注册、付费行为，俗称埋点。埋点被触发的情况下，根据触发发生的条件，一般是设备串号，到同步数据中进行匹配。匹配成功，按文档上报触发数据到第三方广告服务，否则忽略。

*相关表：*
- `s_imeil`: 今日头条同步数据
- `s_huichuan_imeil`: 阿里汇川同步数据

## API
### SDK接口文档
主要包含 `SDK` `v2` 版的接口，`v3` 更新的部分接口，`IOS` 相关的接口
- [v2](./API/index2.md)
- [v3](./API/index3.md)
- [IOS SDK](./API/ios_pay.md)

### 盒子接口文档
- [Box API](./Box/API.md)